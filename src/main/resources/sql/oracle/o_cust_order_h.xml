<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="eorder.o_cust_order_h">
	<insert id="in" parameterType="hashmap">
		INSERT INTO O_CUST_ORDER_H(
			REQ_NO
			, USERID
			, SHIPTO_CD
			, STATUS_CD
			, ZIP_CD
			, ADD1
			, ADD2
			, REQUEST_DT
			, TEL1
			, TEL2
			, TRANS_TY
			, BUILDING_TY
			, REQUEST_TIME
			, REMARK
			, RETURN_DESC
			, RECEIVER
			, RETURN_CD
			, CUST_CD
			, ORDER_DT
			, CANCEL_DT
			, ORDER_MEANS
			, DUMMY
			, INSERTID
			, INSERT_DT
			, INDATE
			, ACCESS_DEVICE
		)VALUES(
			#{m_reqno, jdbcType=VARCHAR}
			, RPAD(#{m_userid, jdbcType=VARCHAR}, 10, ' ')
			, #{m_shiptocd, jdbcType=NUMERIC}
			, #{m_statuscd, jdbcType=VARCHAR}
			, #{m_zipcd, jdbcType=VARCHAR}
			, #{m_add1, jdbcType=VARCHAR}
			, #{m_add2, jdbcType=VARCHAR}
			, #{m_requestdt, jdbcType=VARCHAR}
			, #{m_tel1, jdbcType=VARCHAR}
			, #{m_tel2, jdbcType=VARCHAR}
			, #{m_transty, jdbcType=VARCHAR}
			, #{m_buildingty, jdbcType=VARCHAR}
			, #{m_requesttime, jdbcType=VARCHAR}
			, #{m_remark, jdbcType=VARCHAR}
			, #{m_returndesc, jdbcType=VARCHAR}
			, #{m_receiver, jdbcType=VARCHAR}
			, #{m_returncd, jdbcType=VARCHAR}
			, #{m_custcd, jdbcType=VARCHAR}
			, TO_CHAR(SYSDATE, 'YYYYMMDD')
			, #{m_canceldt, jdbcType=VARCHAR}
			, #{m_ordermeans, jdbcType=VARCHAR}
			, #{m_dummy, jdbcType=VARCHAR}
			, #{m_insertid, jdbcType=VARCHAR}
			, TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI')
			, SYSDATE
			, #{m_accessdevice, jdbcType=VARCHAR}
		)
	</insert>
	
	<update id="up" parameterType="hashmap">
		UPDATE O_CUST_ORDER_H
		<set>
			<if test="m_reqno != null and m_reqno != ''">REQ_NO = #{m_reqno},</if>
			<if test="m_userid != null and m_userid != ''">USERID = RPAD(#{m_userid, jdbcType=VARCHAR}, 10, ' '),</if>
			<if test="m_shiptocd != null">SHIPTO_CD = #{m_shiptocd},</if>
			<if test="m_statuscd != null and m_statuscd != ''">STATUS_CD = #{m_statuscd},</if>
			<if test="m_zipcd != null">ZIP_CD = #{m_zipcd},</if>
			<if test="m_add1 != null">ADD1 = #{m_add1},</if>
			<if test="m_add2 != null">ADD2 = #{m_add2},</if>
			<if test="m_requestdt != null and m_requestdt != ''">REQUEST_DT = #{m_requestdt},</if>
			<if test="m_tel1 != null and m_tel1 != ''">TEL1 = #{m_tel1},</if>
			<if test="m_tel2 != null">TEL2 = #{m_tel2},</if>
			<if test="m_transty != null and m_transty != ''">TRANS_TY = #{m_transty},</if>
			<if test="m_buildingty != null and m_buildingty != ''">BUILDING_TY = #{m_buildingty},</if>
			<if test="m_requesttime != null and m_requesttime != ''">REQUEST_TIME = #{m_requesttime},</if>
			<if test="m_remark != null">REMARK = #{m_remark},</if>
			<if test="m_returndesc != null and m_returndesc != ''">RETURN_DESC = #{m_returndesc},</if>
			<if test="m_receiver != null">RECEIVER = #{m_receiver},</if>
			<if test="m_returncd != null and m_returncd != ''">RETURN_CD = #{m_returncd},</if>
			<if test="m_custcd != null and m_custcd != ''">CUST_CD = #{m_custcd},</if>
			<if test="m_orderdt != null and m_orderdt != ''">ORDER_DT = #{m_orderdt},</if>
			<if test="m_canceldt != null and m_canceldt != ''">CANCEL_DT = TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI'),</if>
			<if test="m_ordermeans != null and m_ordermeans != ''">ORDER_MEANS = #{m_ordermeans},</if>
			<if test="m_dummy != null and m_dummy != ''">DUMMY = #{m_dummy},</if>
			<if test="m_accessdevice != null and m_accessdevice != ''">ACCESS_DEVICE = #{m_accessdevice},</if>
			<if test="m_updateid != null and m_updateid != ''">UPDATEID = #{m_updateid},</if>
			<if test='r_insertdt != null and "Y".equals(r_insertdt)'>
				INSERT_DT = TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI'),
				INDATE = SYSDATE,
			</if>
			UPDATE_DT = TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI'),
			MODATE = SYSDATE
		</set>
		<where>
			AND REQ_NO = #{r_reqno}
		</where>
	</update>
	
	<update id="upReqNo" parameterType="hashmap">
		UPDATE O_CUST_ORDER_H
		<set>
			REQ_NO = #{m_reqno},
			<if test="m_updateid != null and m_updateid != ''">UPDATEID = #{m_updateid},</if>
			UPDATE_DT = TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI'),
			MODATE = SYSDATE
		</set>
		<where>
			AND REQ_NO = #{r_reqno}
		</where>
	</update>
	
	<delete id="del" parameterType="hashmap">
		DELETE O_CUST_ORDER_H
		<where>
			AND REQ_NO = #{r_reqno}
		</where>
	</delete>
	
	<select id="one" parameterType="hashmap" resultType="hashmap">
		SELECT COH.* 
			, (SELECT USER_NM FROM O_USER WHERE USERID = RTRIM(COH.USERID)) AS USER_NM
			, CU.CUST_NM
			, ST.SHIPTO_NM
			, ST.QUOTE_QT
			, US_SALES.USERID AS SALESUSERID, US_SALES.USER_NM AS SALESUSER_NM
			, (SELECT CSUSERID FROM O_CSSALESMAP WHERE SALESUSERID = US_SALES.USERID AND FIXEDYN = 'Y') AS CSUSERID
			, (SELECT SUB1.USER_NM FROM O_USER SUB1, O_CSSALESMAP SUB2 WHERE SUB1.USERID = SUB2.CSUSERID AND SUB2.SALESUSERID = US_SALES.USERID AND SUB2.FIXEDYN = 'Y') AS CSUSER_NM
			, (SELECT CC_NAME FROM COMMONCODE WHERE CC_PARENT='C01' AND CC_CODE = COH.RETURN_CD) AS RETURN_REASON
		FROM O_CUST_ORDER_H COH
			LEFT JOIN O_CUSTOMER CU ON COH.CUST_CD = CU.CUST_CD
			LEFT JOIN O_SHIPTO ST ON COH.SHIPTO_CD = ST.SHIPTO_CD
			LEFT JOIN O_USER US_SALES ON CU.SALESREP_CD = US_SALES.USERID
		<where>
			<if test="r_userid != null and r_userid != '' ">AND COH.USERID = RPAD(#{r_userid}, 10, ' ')</if>
			<if test="r_reqno != null and r_reqno != '' ">AND COH.REQ_NO = #{r_reqno}</if>
			<if test="rl_reqno != null and rl_reqno != '' ">AND COH.REQ_NO LIKE '%' || #{rl_reqno} || '%'</if>
			<if test="r_custcd != null and r_custcd != '' ">AND COH.CUST_CD = #{r_custcd}</if>
			<if test="rl_custcd != null and rl_custcd != '' ">AND COH.CUST_CD LIKE '%' || #{rl_custcd} || '%'</if>
			<if test="r_custnm != null and r_custnm != '' ">AND CU.CUST_NM = #{r_custnm}</if>
			<if test="rl_custnm != null and rl_custnm != '' ">AND CU.CUST_NM LIKE '%' || #{rl_custnm} || '%'</if>
			<if test="r_shiptocd != null and r_shiptocd != '' ">AND COH.SHIPTO_CD = #{r_shiptocd}</if>
			<if test="rl_salesusernm != null and rl_salesusernm != '' ">AND US_SALES.USER_NM LIKE '%' || #{rl_salesusernm} || '%'</if>
			<if test="rl_receiver != null and rl_receiver != '' ">AND COH.RECEIVER LIKE '%' || #{rl_receiver} || '%'</if>
			<if test="r_csuserid != null and r_csuserid != '' ">
				AND US_SALES.USERID IN (SELECT SALESUSERID FROM O_CSSALESMAP WHERE CSUSERID = #{r_csuserid})
			</if>
			<if test="r_insdate != null and r_insdate != '' ">AND COH.INDATE <![CDATA[>=]]> TO_DATE(#{r_insdate}, 'YYYY-MM-DD')</if>
			<if test="r_inedate != null and r_inedate != '' ">AND COH.INDATE <![CDATA[<]]> TO_DATE(#{r_inedate}, 'YYYY-MM-DD') + 1</if>
			<if test="r_statuscd != null and r_statuscd != '' ">AND COH.STATUS_CD = #{r_statuscd}</if>
			<if test="ri_statuscd != null">
   				AND COH.STATUS_CD IN <foreach collection="ri_statuscd" item="status_cd" separator="," open="(" close=")">#{status_cd}</foreach>
 			</if>
			
			<!-- 관리자 권한에 따른 조건절 -->
 			<if test="r_adminauthority != null and r_adminauthority != '' ">
 				<if test='"AD".equals(r_adminauthority)'>
 				</if>
 				<if test='"CS".equals(r_adminauthority)'>
 					AND CU.SALESREP_CD IN (SELECT SALESUSERID FROM O_CSSALESMAP WHERE CSUSERID = #{r_adminuserid})
 				</if>
 				<if test='"SH".equals(r_adminauthority) or "SM".equals(r_adminauthority) or "SR".equals(r_adminauthority)'>
 					<if test='"SH".equals(r_adminauthority)'>
 						AND CU.SALESREP_CD IN (SELECT USERID FROM O_USER WHERE USER_CATE2 = #{r_adminuserid})
 					</if>
 					<if test='"SM".equals(r_adminauthority)'>
 						AND CU.SALESREP_CD IN (SELECT USERID FROM O_USER WHERE USER_CATE3 = #{r_adminuserid})
 					</if>
 					<if test='"SR".equals(r_adminauthority)'>
 						AND CU.SALESREP_CD = #{r_adminuserid}
 					</if>
 				</if>
 				<if test='"MK".equals(r_adminauthority)'>
 				</if>
 			</if>
		</where>
	</select>
	
	<select id="cnt" parameterType="hashmap" resultType="int">
		SELECT COUNT(*) 
		FROM O_CUST_ORDER_H COH
			LEFT JOIN O_CUSTOMER CU ON COH.CUST_CD = CU.CUST_CD
			LEFT JOIN O_SHIPTO ST ON COH.SHIPTO_CD = ST.SHIPTO_CD
			LEFT JOIN O_USER US_SALES ON CU.SALESREP_CD = US_SALES.USERID
		<where>
			<if test="r_userid != null and r_userid != '' ">AND COH.USERID = RPAD(#{r_userid}, 10, ' ')</if>
			<if test="r_reqno != null and r_reqno != '' ">AND COH.REQ_NO = #{r_reqno}</if>
			<if test="rl_reqno != null and rl_reqno != '' ">AND COH.REQ_NO LIKE '%' || #{rl_reqno} || '%'</if>
			<if test="r_custcd != null and r_custcd != '' ">AND COH.CUST_CD = #{r_custcd}</if>
			<if test="rl_custcd != null and rl_custcd != '' ">AND COH.CUST_CD LIKE '%' || #{rl_custcd} || '%'</if>
			<if test="r_custnm != null and r_custnm != '' ">AND CU.CUST_NM = #{r_custnm}</if>
			<if test="rl_custnm != null and rl_custnm != '' ">AND CU.CUST_NM LIKE '%' || #{rl_custnm} || '%'</if>
			<if test="r_shiptocd != null and r_shiptocd != '' ">AND COH.SHIPTO_CD = #{r_shiptocd}</if>
			<if test="rl_salesusernm != null and rl_salesusernm != '' ">AND US_SALES.USER_NM LIKE '%' || #{rl_salesusernm} || '%'</if>
			<if test="rl_receiver != null and rl_receiver != '' ">AND COH.RECEIVER LIKE '%' || #{rl_receiver} || '%'</if>
			<if test="r_csuserid != null and r_csuserid != '' ">
				AND US_SALES.USERID IN (SELECT SALESUSERID FROM O_CSSALESMAP WHERE CSUSERID = #{r_csuserid})
			</if>
			<if test="r_insdate != null and r_insdate != '' ">AND COH.INDATE <![CDATA[>=]]> TO_DATE(#{r_insdate}, 'YYYY-MM-DD')</if>
			<if test="r_inedate != null and r_inedate != '' ">AND COH.INDATE <![CDATA[<]]> TO_DATE(#{r_inedate}, 'YYYY-MM-DD') + 1</if>
			<if test="r_statuscd != null and r_statuscd != '' ">AND COH.STATUS_CD = #{r_statuscd}</if>
			<if test="ri_statuscd != null">
   				AND COH.STATUS_CD IN <foreach collection="ri_statuscd" item="status_cd" separator="," open="(" close=")">#{status_cd}</foreach>
 			</if>
 			
 			<!-- 관리자 권한에 따른 조건절 -->
 			<if test="r_adminauthority != null and r_adminauthority != '' ">
 				<if test='"AD".equals(r_adminauthority)'>
 				</if>
 				<if test='"CS".equals(r_adminauthority)'>
 					AND CU.SALESREP_CD IN (SELECT SALESUSERID FROM O_CSSALESMAP WHERE CSUSERID = #{r_adminuserid})
 				</if>
 				<if test='"SH".equals(r_adminauthority) or "SM".equals(r_adminauthority) or "SR".equals(r_adminauthority)'>
 					<if test='"SH".equals(r_adminauthority)'>
 						AND CU.SALESREP_CD IN (SELECT USERID FROM O_USER WHERE USER_CATE2 = #{r_adminuserid})
 					</if>
 					<if test='"SM".equals(r_adminauthority)'>
 						AND CU.SALESREP_CD IN (SELECT USERID FROM O_USER WHERE USER_CATE3 = #{r_adminuserid})
 					</if>
 					<if test='"SR".equals(r_adminauthority)'>
 						AND CU.SALESREP_CD = #{r_adminuserid}
 					</if>
 				</if>
 				<if test='"MK".equals(r_adminauthority)'>
 				</if>
 			</if>
 			<!-- End. -->
		</where>
	</select>
	
	<select id="list" parameterType="hashmap" resultType="hashmap">
		SELECT * FROM (SELECT ROWNUM RR, XX.* FROM (
		
		SELECT COH.*
			, (SELECT USER_NM FROM O_USER WHERE USERID = RTRIM(COH.USERID)) AS USER_NM
			, CU.CUST_NM
			, ST.SHIPTO_NM
			, US_SALES.USERID AS SALESUSERID, US_SALES.USER_NM AS SALESUSER_NM
			, (SELECT CSUSERID FROM O_CSSALESMAP WHERE SALESUSERID = US_SALES.USERID AND FIXEDYN = 'Y') AS CSUSERID
			, (SELECT SUB1.USER_NM FROM O_USER SUB1, O_CSSALESMAP SUB2 WHERE SUB1.USERID = SUB2.CSUSERID AND SUB2.SALESUSERID = US_SALES.USERID AND SUB2.FIXEDYN = 'Y') AS CSUSER_NM
			, (SELECT COUNT(*) FROM O_CUST_ORDER_D WHERE REQ_NO = COH.REQ_NO) AS ITEM_CNT
			, (SELECT CONFIRM_DT FROM O_ORDER_CONFIRM_H WHERE REQ_NO = COH.REQ_NO AND ROWNUM = 1) AS CONFIRM_DT2
			, QM.QMS_TEMP_ID
		FROM O_CUST_ORDER_H COH
			LEFT OUTER JOIN QMS_PRE_MAST QM ON QM.REQ_NO = COH.REQ_NO AND QM.DELETEYN = 'N'
			LEFT JOIN O_CUSTOMER CU ON COH.CUST_CD = CU.CUST_CD
			LEFT JOIN O_SHIPTO ST ON COH.SHIPTO_CD = ST.SHIPTO_CD
			LEFT JOIN O_USER US_SALES ON CU.SALESREP_CD = US_SALES.USERID
		<where>
			<if test="r_userid != null and r_userid != '' ">AND COH.USERID = RPAD(#{r_userid}, 10, ' ')</if>
			<if test="r_reqno != null and r_reqno != '' ">AND COH.REQ_NO = #{r_reqno}</if>
			<if test="rl_reqno != null and rl_reqno != '' ">AND COH.REQ_NO LIKE '%' || #{rl_reqno} || '%'</if>
			<if test="r_custcd != null and r_custcd != '' ">AND COH.CUST_CD = #{r_custcd}</if>
			<if test="rl_custcd != null and rl_custcd != '' ">AND COH.CUST_CD LIKE '%' || #{rl_custcd} || '%'</if>
			<if test="r_custnm != null and r_custnm != '' ">AND CU.CUST_NM = #{r_custnm}</if>
			<if test="rl_custnm != null and rl_custnm != '' ">AND CU.CUST_NM LIKE '%' || #{rl_custnm} || '%'</if>
			<if test="r_shiptocd != null and r_shiptocd != '' ">AND COH.SHIPTO_CD = #{r_shiptocd}</if>
			<if test="rl_salesusernm != null and rl_salesusernm != '' ">AND US_SALES.USER_NM LIKE '%' || #{rl_salesusernm} || '%'</if>
			<if test="rl_receiver != null and rl_receiver != '' ">AND COH.RECEIVER LIKE '%' || #{rl_receiver} || '%'</if>
			<if test="r_csuserid != null and r_csuserid != '' ">
				AND US_SALES.USERID IN (SELECT SALESUSERID FROM O_CSSALESMAP WHERE CSUSERID = #{r_csuserid})
			</if>
			<if test="r_insdate != null and r_insdate != '' ">AND COH.INDATE <![CDATA[>=]]> TO_DATE(#{r_insdate}, 'YYYY-MM-DD')</if>
			<if test="r_inedate != null and r_inedate != '' ">AND COH.INDATE <![CDATA[<]]> TO_DATE(#{r_inedate}, 'YYYY-MM-DD') + 1</if>
			<if test="r_statuscd != null and r_statuscd != '' ">AND COH.STATUS_CD = #{r_statuscd}</if>
			<if test="ri_statuscd != null">
   				AND COH.STATUS_CD IN <foreach collection="ri_statuscd" item="status_cd" separator="," open="(" close=")">#{status_cd}</foreach>
 			</if>
			<if test="ri_reqno != null">
   				AND COH.REQ_NO IN <foreach collection="ri_reqno" item="req_no" separator="," open="(" close=")">#{req_no}</foreach>
 			</if>
 			
 			<!-- 관리자 권한에 따른 조건절 -->
 			<if test="r_adminauthority != null and r_adminauthority != '' ">
 				<if test='"AD".equals(r_adminauthority)'>
 				</if>
 				<if test='"CS".equals(r_adminauthority)'>
 					AND CU.SALESREP_CD IN (SELECT SALESUSERID FROM O_CSSALESMAP WHERE CSUSERID = #{r_adminuserid})
 				</if>
 				<if test='"SH".equals(r_adminauthority) or "SM".equals(r_adminauthority) or "SR".equals(r_adminauthority)'>
 					<if test='"SH".equals(r_adminauthority)'>
 						AND CU.SALESREP_CD IN (SELECT USERID FROM O_USER WHERE USER_CATE2 = #{r_adminuserid})
 					</if>
 					<if test='"SM".equals(r_adminauthority)'>
 						AND CU.SALESREP_CD IN (SELECT USERID FROM O_USER WHERE USER_CATE3 = #{r_adminuserid})
 					</if>
 					<if test='"SR".equals(r_adminauthority)'>
 						AND CU.SALESREP_CD = #{r_adminuserid}
 					</if>
 				</if>
 				<if test='"MK".equals(r_adminauthority)'>
 				</if>
 			</if>
 			<!-- End. -->
		</where>
		
		<if test=" r_orderby != null and r_orderby != '' ">ORDER BY ${r_orderby}</if>
		) XX 
		<where>
			<if test="r_endrow != null and r_endrow != ''"><![CDATA[ROWNUM <= #{r_endrow}]]></if>		
		</where> )
		<where>
			<if test="r_startrow != null and r_startrow != ''"><![CDATA[RR >= #{r_startrow}]]></if>
		</where>
	</select>
	
	<select id="createCustOrderReqNo" parameterType="hashmap" resultType="String">
		<!-- 이전 이오더 주문번호 생성 쿼리 -->
		<!-- 
		SELECT SF_GETORDERSEQ(#{r_custcd}) AS REQ_NO
		FROM O_CUSTOMER
		WHERE CUST_CD = #{r_custcd}
		 -->
		 
		SELECT '${r_custcd}' || TO_CHAR(SYSDATE, 'YYMMDD') || TO_CHAR(NVL2(MAX(REQ_NO), TO_NUMBER(REPLACE(MAX(TO_NUMBER(REQ_NO)), '${r_custcd}' || TO_CHAR(SYSDATE, 'YYMMDD'), ''))+1, 1))
		FROM O_CUST_ORDER_H
		WHERE CUST_CD = #{r_custcd}
		AND REQ_NO NOT LIKE 'T%'
		AND REQ_NO LIKE '${r_custcd}' || TO_CHAR(SYSDATE, 'YYMMDD') || '%'
		 
	</select>
	
</mapper>