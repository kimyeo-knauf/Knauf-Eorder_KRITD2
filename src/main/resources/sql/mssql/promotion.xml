<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="eorder.promotion">
	<insert id="in" parameterType="hashmap">
	<!-- 2024-10-15 HSG MSSQL에서는 SEQUENCE를 사용할 수 없어 MAX로 대체 -->
		<selectKey keyProperty="prmSeq" resultType="long" order="BEFORE">
    		SELECT MAX(P.PRM_SEQ)+1 FROM PROMOTION P;
    	</selectKey>
	    insert into PROMOTION
			  (PRM_SEQ,
			   PRM_CODE,
			   PRM_TYPE,
			   PRM_TITLE,
			   PRM_SDATE,
			   PRM_EDATE,
			   PRM_IMAGE1,
			   PRM_IMAGE1TYPE,
			   PRM_IMAGE2,
			   PRM_IMAGE2TYPE,
			   PRM_USEYN,
			   PRM_INID,
			   PRM_INDATE
			  )
		values (
			<!-- 2024-10-15 HSG MSSQL에서는 SEQUENCE를 사용할 수 없어 MAX로 대체 -->
			   #{prmSeq}
			   ,#{ m_prmcode }
			   ,#{ m_prmtype }
			   ,#{ m_prmtitle }
			   ,CONVERT(CHAR(10), #{ m_prmsdate }, 23)
			   ,CONVERT(CHAR(10), #{ m_prmedate }, 23)
			   ,#{ m_prmimage1 }
			   ,#{ m_prmimage1type }
			   ,#{ m_prmimage2 }
			   ,#{ m_prmimage2type }
			   ,'Y'
			   ,#{ m_prminid }
			   ,GETDATE()
			  )
<!-- 2024-10-15 HSG 주석 처리		<selectKey resultType="long" keyProperty="nowSeq" order="AFTER">
			SELECT USQ_PROMOTION.CURRVAL FROM DUAL
		</selectKey>-->
	</insert>

	<update id="up" parameterType="hashmap" >
		UPDATE PROMOTION
		<set>
			<if test=" m_prmtype != null and m_prmtype != '' ">PRM_TYPE = #{ m_prmtype }, </if>
			<if test=" m_prmtitle != null and m_prmtitle != '' ">PRM_TITLE = #{ m_prmtitle }, </if>
<!--	2024-10-15 HSG 주석 처리 후 아래 코드 삽입		<if test=" m_prmsdate != null and m_prmsdate != '' ">PRM_SDATE = TO_DATE(#{ m_prmsdate },'yyyy-MM-dd'), </if>
			<if test=" m_prmedate != null and m_prmedate != '' ">PRM_EDATE = TO_DATE(#{ m_prmedate },'yyyy-MM-dd'), </if> -->
			<if test=" m_prmsdate != null and m_prmsdate != '' ">PRM_SDATE = CONVERT(DATETIME, #{ m_prmsdate }), </if>
			<if test=" m_prmedate != null and m_prmedate != '' ">PRM_EDATE = CONVERT(DATETIME, #{ m_prmedate }), </if>
			<if test=" m_prmimage1 != null and m_prmimage1 != '' ">PRM_IMAGE1 = #{ m_prmimage1 }, </if>
			<if test=" m_prmimage1type != null and m_prmimage1type != '' ">PRM_IMAGE1TYPE = #{ m_prmimage1type }, </if>
			<if test=" m_prmimage2 != null and m_prmimage2 != '' ">PRM_IMAGE2 = #{ m_prmimage2 }, </if>
			<if test=" m_prmimage2type != null and m_prmimage2type != '' ">PRM_IMAGE2TYPE = #{ m_prmimage2type }, </if>
			<if test=" m_prmmoid != null and m_prmmoid != '' ">PRM_MOID = #{ m_prmmoid }, </if>
			PRM_MODATE = GETDATE()
		</set>
		<where>
			AND PRM_SEQ = #{ r_prmseq }
		</where>
	</update>

	<delete id="del" parameterType="hashmap" >
		DELETE FROM PROMOTION
		<where>
			AND PRM_SEQ = #{ r_prmseq }
		</where>
	</delete>

	<select id="list" parameterType="hashmap" resultType="hashmap">
		SELECT * FROM (SELECT 
			ROW_NUMBER() OVER(
			<choose>
				<when test = " r_orderby != null and r_orderby != '' ">ORDER BY ${r_orderby}</when>
				<otherwise>ORDER BY (SELECT 1)</otherwise>
			</choose>
			) AS ROWNUM
			, XX.* FROM (
			SELECT PRM.*,US.*,
				   CASE WHEN <![CDATA[PRM_SDATE <= GETDATE() AND PRM_EDATE >= DATEADD(DAY, -1, GETDATE() )]]> THEN '진행중'
				   	    WHEN PRM_EDATE <![CDATA[<]]> DATEADD(DAY, -1, GETDATE() ) THEN '진행완료'
				   ELSE '진행대기'
				   END AS PRMONGOINGYN
			FROM PROMOTION PRM
			LEFT OUTER JOIN O_USER US ON PRM.PRM_INID = US.USERID
			<where>
				<if test=" r_prmtype != null and r_prmtype != '' ">AND PRM_TYPE = #{ r_prmtype }</if>
				<if test=" r_prmongoing != null and r_prmongoing != ''">
					<if test='r_prmongoing.equals("W") '>AND PRM_SDATE <![CDATA[>]]> GETDATE()</if>
					<if test='r_prmongoing.equals("Y") '>AND <![CDATA[PRM_SDATE <= GETDATE() AND PRM_EDATE >= DATEADD(DAY, -1, GETDATE() )]]></if>
					<if test='r_prmongoing.equals("N") '>AND PRM_EDATE <![CDATA[<]]> DATEADD(DAY, -1, GETDATE() )</if>
					<if test='r_prmongoing.equals("WY") or r_prmongoing.equals("YW") '>AND PRM_EDATE <![CDATA[>=]]> DATEADD(DAY, -1, GETDATE() )</if>
					<if test='r_prmongoing.equals("WN") or r_prmongoing.equals("NW") '>AND <![CDATA[ PRM_SDATE > GETDATE() OR PRM_EDATE < DATEADD(DAY, -1, GETDATE() )]]></if>
					<if test='r_prmongoing.equals("YN") or r_prmongoing.equals("NY") '>AND PRM_SDATE <![CDATA[<=]]> GETDATE()</if>
				</if>
				<if test="rl_prmtitle != null and rl_prmtitle != '' ">AND PRM_TITLE LIKE '%' + #{rl_prmtitle} + '%'</if>
			</where>
			) XX 
		) S
		<where>
			<if test="r_endrow != null and r_endrow != '' and r_startrow != null and r_startrow != ''" >	
				ROWNUM BETWEEN #{r_startrow} AND #{r_endrow}
			</if>
		</where>
	</select>

	<select id="cnt" parameterType="hashmap" resultType="long">
		SELECT COUNT(*) FROM PROMOTION
		<where>
			<if test=" r_prmtype != null and r_prmtype != '' ">AND PRM_TYPE = #{ r_prmtype }</if>
			<if test=" r_prmongoing != null and r_prmongoing != ''">
				<if test='r_prmongoing.equals("W") '>AND PRM_SDATE <![CDATA[>]]> GETDATE()</if>
				<if test='r_prmongoing.equals("Y") '>AND <![CDATA[PRM_SDATE <= GETDATE() AND PRM_EDATE >= DATEADD(DAY, -1, GETDATE() )]]></if>
				<if test='r_prmongoing.equals("N") '>AND PRM_EDATE <![CDATA[<]]> DATEADD(DAY, -1, GETDATE() )</if>
				<if test='r_prmongoing.equals("WY") or r_prmongoing.equals("YW") '>AND PRM_EDATE <![CDATA[>=]]> DATEADD(DAY, -1, GETDATE() )</if>
				<if test='r_prmongoing.equals("WN") or r_prmongoing.equals("NW") '>AND <![CDATA[ PRM_SDATE > GETDATE() OR PRM_EDATE < DATEADD(DAY, -1, GETDATE() )]]></if>
				<if test='r_prmongoing.equals("YN") or r_prmongoing.equals("NY") '>AND PRM_SDATE <![CDATA[<=]]> GETDATE()</if>
			</if>
			<if test="rl_prmtitle != null and rl_prmtitle != '' ">AND PRM_TITLE LIKE '%' + #{rl_prmtitle} + '%'</if>
	    </where>
	</select>

	<select id="listForFront" parameterType="hashmap" resultType="hashmap">
		SELECT * FROM (SELECT 
			ROW_NUMBER() OVER(
			<choose>
				<when test = " r_orderby != null and r_orderby != '' ">ORDER BY ${r_orderby}</when>
				<otherwise>ORDER BY (SELECT 1)</otherwise>
			</choose>
			) AS ROWNUM
			, XX.* FROM (
		SELECT PRM.*
		FROM PROMOTION PRM
		<where>
			<if test=" r_prmtype != null and r_prmtype != '' ">AND PRM_TYPE = #{ r_prmtype }</if>
			<if test=" r_prmongoing != null and r_prmongoing != ''">
				<if test='r_prmongoing.equals("Y") '>AND <![CDATA[PRM_SDATE <= GETDATE() AND PRM_EDATE >= DATEADD(DAY, -1, GETDATE() )]]></if>   <!-- 진행중-->
				<if test='r_prmongoing.equals("N") '>AND PRM_EDATE <![CDATA[<]]> DATEADD(DAY, -1, GETDATE() )</if> <!-- 진행완료-->
			</if>
			<if test="rl_prmtitle != null and rl_prmtitle != '' ">AND PRM_TITLE LIKE '%' + #{rl_prmtitle} + '%'</if>
		</where>
		) XX ) S
		<where>
			<if test="r_endrow != null and r_endrow != '' and r_startrow != null and r_startrow != ''" >	
				ROWNUM BETWEEN #{r_startrow} AND #{r_endrow}
			</if>
		</where>
	</select>

	<select id="one" parameterType="hashmap" resultType="hashmap">		
		SELECT PRM.*, US.*
		  FROM PROMOTION PRM
		  LEFT OUTER JOIN O_USER US ON PRM.PRM_INID = US.USERID
		  <where>
		  	PRM_SEQ = #{ r_prmseq }
	      </where>			      	     	     	
	</select>

	<select id="maxCode" parameterType="hashmap" resultType="string">		
		SELECT 'PROMOTION' + FORMAT(MAX(CAST(SUBSTRING('PRM_CODE', 10, LEN('PRM_CODE')) AS FLOAT) + 1), '000')
		FROM PROMOTION
		
<!-- 2024-11-06 hsg PlayStation4 mybatis의 sql 파일은 XML로 작성하는데, 흔히 사용하는 SQL의 주석처리 방법 - -는 XML에서 사용하는 문법이 아니기 때문에 발생.
 		SELECT 'PROMOTION' + LPAD(MAX(TO_NUMBER(SUBSTRING(PRM_CODE, 10, LEN(PRM_CODE))) + 1), 3, '0')
 		SELECT LPAD(INULLS(MAX(PRM_CODE),0)+1,3,'0') FROM PROMOTION -->
	</select>
	
</mapper>